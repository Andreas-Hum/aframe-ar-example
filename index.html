<script>
      // Component to handle shadow planes (keeps shadow on the floor)
      AFRAME.registerComponent('follow-shadow', {
        schema: {type: 'selector'},
        init() {this.el.object3D.renderOrder = -1;},
        tick() {
          if (this.data) {
            this.el.object3D.position.copy(this.data.object3D.position);
            this.el.object3D.position.y -= 0.001; // Slightly below object to prevent flickering
          }
        }
      });

      // FIXED SPAWN COMPONENT
      AFRAME.registerComponent('spawn-in-ar', {
        schema: {
          template: {type: 'selector'}
        },
        init: function() {
          // Listen for the tap event
          this.el.sceneEl.addEventListener('select', () => {
            const template = this.data.template;

            // 1. Safety Check: Only spawn if the ghost is currently visible
            if (!template || !template.object3D.visible) {
                console.log("Ghost not visible, skipping spawn.");
                return;
            }

            // 2. Clone the HTML structure
            const newObject = template.cloneNode(true);
            newObject.removeAttribute('id'); // Remove ID to avoid duplicates

            // 3. LOCK THE TRANSFORM (The Fix)
            // We cannot pass the object3D.position directly. We must extract x, y, z.
            const currentPos = template.object3D.position;
            const currentRot = template.object3D.rotation;
            const currentScale = template.object3D.scale;

            // Apply Position
            newObject.setAttribute('position', {
                x: currentPos.x,
                y: currentPos.y,
                z: currentPos.z
            });

            // Apply Rotation (Convert Radians to Degrees!)
            newObject.setAttribute('rotation', {
                x: THREE.MathUtils.radToDeg(currentRot.x),
                y: THREE.MathUtils.radToDeg(currentRot.y),
                z: THREE.MathUtils.radToDeg(currentRot.z)
            });

            // Apply Scale
            newObject.setAttribute('scale', {
                x: currentScale.x,
                y: currentScale.y,
                z: currentScale.z
            });

            // 4. Ensure it is visible
            newObject.setAttribute('visible', 'true');

            // 5. Add to scene
            this.el.sceneEl.appendChild(newObject);
            
            console.log("Object Spawned!"); // Debug message in console
          });
        }
      });
    </script>
